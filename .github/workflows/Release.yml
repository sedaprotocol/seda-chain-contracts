name: Release
on:
  push:
    tags:
      - '*'

permissions:
  contents: write
  pull-requests: write

env:
  RUST_BACKTRACE: 1

jobs:
  release:
    name: Release Build
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v3

      - name: ðŸ“¥ Install stable toolchain
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: 1.72.1
          target: wasm32-unknown-unknown
          override: true

      - name: ðŸ”¨ Compile optimized WASM contracts
        run: |
          docker run --rm -v $GITHUB_WORKSPACE:/code \
          --mount type=volume,source=contract_cache,target=/code/target \
          --mount type=volume,source=registry_cache,target=/usr/local/cargo/registry \
          cosmwasm/rust-optimizer:0.12.11

      - name: ðŸªµ Conventional Changelog
        id: changelog
        uses: TriPSs/conventional-changelog-action@v3
        with:
          github-token: ${{ secrets.github_token }}
          output-file: "false"
          skip-commit: true
          skip-tag: true
          skip-git-pull: true
          git-push: false

      - name: ðŸ§¾ Generate Checksum
        uses: jmgilman/actions-generate-checksum@v1
        with:
          patterns: |
            artifacts/data_requests.wasm
            artifacts/proxy_contract.wasm
            artifacts/staking.wasm

      - name: ðŸ“¦ Create GitHub Release
        uses: ncipollo/release-action@v1
        with:
          allowUpdates: true
          generateReleaseNotes: true
          body: ${{ steps.changelog.outputs.clean_changelog }}
          artifacts: "checksum.txt,artifacts/data_requests.wasm,artifacts/proxy_contract.wasm,artifacts/staking.wasm"
